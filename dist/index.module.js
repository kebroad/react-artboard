import{useState as t,useRef as r,useCallback as n,forwardRef as e,useEffect as o,useImperativeHandle as i,useMemo as u}from"react";import c from"tinycolor2";import{jsx as a}from"react/jsx-runtime";function l(t,r){var n=Math.round(Math.random()*r),e=1-Math.random()/4;return c(t).darken(n-r/2).setAlpha(e).toPercentageRgbString()}var s=function(t,r,n){return[n[0]+t*Math.cos(r),n[1]+t*Math.sin(r)]};function h(t){return"url("+function(t){return"data:image/svg+xml;base64,"+btoa(function(t){return"<svg xmlns='http://www.w3.org/2000/svg' width='"+t+"' height='"+t+"' viewBox='0 0 "+t+" "+t+"'><circle r='"+t/2+"' cy='"+t/2+"' cx='"+t/2+"' stroke-width='1' stroke='rgba(0,0,0,0.5)' fill='none'/></svg>"}(t))}(t)+") "+t/2+" "+t/2+", crosshair"}function f(e){var o=e.color,i=void 0===o?"#000000":o,u=e.strokeWidth,c=void 0===u?25:u,a=e.varyBrightness,f=void 0===a?5:a,d=t([]),v=d[0],g=d[1],m=r(),p=r();return{name:"Paintbrush",startStroke:n(function(t){m.current=void 0,g(function(t,r,n){for(var e=[],o=Math.round(t/3),i=t/o,u=0;u<o;u++){var c=0===u?0:i*u+Math.random()*i/2-i/2;e.push({distance:c,thickness:2*Math.random()+2,colour:l(r,n)})}return e}(c,i,f)),p.current=t},[g,c,i,f]),continueStroke:n(function(t,r){if(p.current){var n=(l=m.current,u=p.current,a=t,h=(Math.atan2(a[1]-u[1],a[0]-u[0])-Math.PI/2)%(2*Math.PI),void 0===l?h:l-(e=h,o=2*Math.PI,(i=(l-(e>0?e:e+o)+Math.PI)%o-Math.PI)<-Math.PI?i+o:i));void 0===m.current&&(m.current=n%(2*Math.PI)),function(t,r,n,e,o,i,u){t.forEach(function(t){u.beginPath(),function(t,r,n,e,o){o.beginPath(),o.moveTo(t[0],t[1]),o.strokeStyle=n.colour,o.lineWidth=n.thickness,o.lineCap="round",o.lineJoin="round",o.shadowColor=n.colour,o.shadowBlur=n.thickness/2,o.quadraticCurveTo(e[0],e[1],r[0],r[1]),o.lineTo(r[0],r[1]),o.stroke()}(s(t.distance-i/2,e,r),s(t.distance-i/2,o,n),t,s(t.distance-i/2,o,r),u)})}(v,p.current,t,m.current,n,c,r),m.current=n%(2*Math.PI),p.current=t}else p.current=t;var e,o,i,u,a,l,h},[v,c]),cursor:h(c)}}function d(t){var e=t.color,o=void 0===e?"#000000":e,i=t.strokeWidth,u=void 0===i?25:i,c=r();return{name:"Marker",startStroke:n(function(t,r){r.lineWidth=3,r.lineJoin=r.lineCap="round",c.current=t,r.strokeStyle=o},[o]),continueStroke:n(function(t,r){if(c.current){if(c.current[0]!==t[0]||c.current[1]!==t[1]){r.beginPath();for(var n=0;n<u;n+=2){var e=Math.round(u/2-n);r.globalAlpha=1/u*(u-n),r.moveTo(c.current[0]-e,c.current[1]-e),r.lineTo(t[0]-e,t[1]-e),r.stroke()}r.globalAlpha=1,r.beginPath(),c.current=t}}else c.current=t},[u,c]),cursor:h(u)}}function v(t){var r=t.color,e=void 0===r?"#000000":r,o=t.strokeWidth,i=void 0===o?25:o,u=n(function(t,r){r.globalCompositeOperation="darken",r.lineWidth=i,r.lineJoin=r.lineCap="round",r.strokeStyle=e,r.shadowBlur=.5*i,r.shadowColor=c(e).setAlpha(.5).toPercentageRgbString(),console.log(r.shadowColor),r.moveTo(t[0],t[1]),r.beginPath()},[e,i]),a=n(function(t){t.globalCompositeOperation="source-over"},[]);return{name:"Airbrush",startStroke:u,continueStroke:n(function(t,r){r.lineTo(t[0],t[1]),r.stroke()},[]),endStroke:a,cursor:h(i)}}function g(){return(g=Object.assign||function(t){for(var r=1;r<arguments.length;r++){var n=arguments[r];for(var e in n)Object.prototype.hasOwnProperty.call(n,e)&&(t[e]=n[e])}return t}).apply(this,arguments)}function m(t,r){(null==r||r>t.length)&&(r=t.length);for(var n=0,e=new Array(r);n<r;n++)e[n]=t[n];return e}function p(t){var e=t.color,o=void 0===e?"#000000":e,i=t.neighbourColor,u=t.distanceThreshold,a=void 0===u?40:u,l=t.neighbourStrokeWidth,s=void 0===l?1:l,h=t.spreadFactor,f=void 0===h?.9:h;i||(i=c(o).setAlpha(.2).toPercentageRgbString());var d=r([]),v=a*a;return{name:"Shading",startStroke:n(function(t,r){r.globalCompositeOperation="darken",r.lineWidth=1,r.lineJoin=r.lineCap="round",d.current=[t]},[]),continueStroke:n(function(t,r){r.strokeStyle=o,r.lineWidth=1,d.current.push(t),r.beginPath();var n=d.current[d.current.length-2];r.moveTo(n[0],n[1]),r.lineTo.apply(r,t),r.stroke(),r.lineWidth=s;for(var e,u=function(t,r){var n;if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(n=function(t,r){if(t){if("string"==typeof t)return m(t,r);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?m(t,r):void 0}}(t))){n&&(t=n);var e=0;return function(){return e>=t.length?{done:!0}:{done:!1,value:t[e++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}return(n=t[Symbol.iterator]()).next.bind(n)}(d.current);!(e=u()).done;){var c=e.value,a=c[0]-t[0],l=c[1]-t[1],h=a*a+l*l;h<v&&Math.random()>h/v&&(r.beginPath(),r.strokeStyle=i,r.moveTo(t[0]+a*f,t[1]+l*f),r.lineTo(c[0]-a*f,c[1]-l*f),r.stroke())}},[s,o,f,v,i]),endStroke:n(function(t){t.globalCompositeOperation="source-over"},[]),cursor:"crosshair"}}var k=null;function S(){var t,r,n,e,o;if(null!==k)t=k,k=null;else{do{e=(r=2*Math.random()-1)*r+(n=2*Math.random()-1)*n}while(0===e||e>=1);t=r*(o=Math.sqrt(-2*Math.log(e)/e)),k=n*o}return t}function b(t,r,n,e,o){if(n<0)return[];var i=(t[1]+r[1])/2,u=[(t[0]+r[0])/2+S()*e,i+S()*e],c=b(t,u,n-1,e/o,o);return c.push(u),c.push.apply(c,b(u,r,n-1,e/o,o)),c}function y(t,r,n){r.beginPath(),function(t,r,n){return function(t,r,n,e){for(var o=[],i=0;i<t.length;i++){var u=t[i],c=t[(i+1)%t.length];o.push(u),o.push.apply(o,b(u,c,5,n,2))}return o}(function(t,r,n){for(var e=2*Math.PI/r,o=[],i=1;i<=r;i++)o.push([n*Math.cos(e*i)+t[0],n*Math.sin(e*i)+t[1]]);return o}(t,r,n),0,n/10)}(t,Math.round(n/5),n).forEach(function(t){r.lineTo.apply(r,t)}),r.closePath(),r.fill()}function P(t,r,n,e){for(var o=Math.min(n,t.length/3),i=0;i<o;i++)e.globalAlpha=.01-.009/o*i,y(t[t.length-3*i-1],e,r+r/o*i);e.globalAlpha=.1}function M(t){var e=t.color,o=void 0===e?"#000000":e,i=t.strokeWidth,u=void 0===i?25:i,c=r([]),a=n(function(t,r){r.fillStyle=o,r.shadowColor=o,r.globalAlpha=.01,c.current=[t],P(c.current,1.1*u,1,r)},[o,u]),l=n(function(){c.current=[]},[]);return{name:"Watercolor",startStroke:a,continueStroke:n(function(t,r){c.current.push(t),P(c.current,u,5,r)},[u]),endStroke:l,cursor:h(u)}}function w(t){var r=t.strokeWidth,e=void 0===r?25:r;return{name:"Eraser",startStroke:n(function(t,r){r.globalCompositeOperation="source-over",r.lineWidth=e,r.strokeStyle="#ffffff",r.lineJoin=r.lineCap="round",r.moveTo(t[0],t[1]),r.beginPath()},[e]),continueStroke:n(function(t,r){r.lineTo(t[0],t[1]),r.stroke()},[]),cursor:h(e)}}var C=function(t){if(!t.currentTarget)return[0,0];var r=t.currentTarget.getBoundingClientRect(),n=t.targetTouches[0];return[n.clientX-r.left,n.clientY-r.top]},T=function(t){return[t.nativeEvent.offsetX,t.nativeEvent.offsetY]},A=function(t){return 1==(1&t)},O=e(function(r,e){var u=r.tool,c=r.style,l=r.history,s=r.onStartStroke,h=r.onContinueStroke,f=r.onEndStroke,d=function(t,r){if(null==t)return{};var n,e,o={},i=Object.keys(t);for(e=0;e<i.length;e++)r.indexOf(n=i[e])>=0||(o[n]=t[n]);return o}(r,["tool","style","history","onStartStroke","onContinueStroke","onEndStroke"]),v=t(),m=v[0],p=v[1],k=t(),S=k[0],b=k[1],y=t(!1),P=y[0],M=y[1],w=n(function(t){m&&(m.save(),M(!0),null==u.startStroke||u.startStroke(t,m),null==s||s(t))},[u,m,s]),O=n(function(t){m&&(null==u.continueStroke||u.continueStroke(t,m),null==h||h(t))},[u,m,h]),x=n(function(){M(!1),m&&(null==u.endStroke||u.endStroke(m),null==f||f(),m.restore(),S&&l&&l.pushState(S))},[u,m,S,l,f]),E=n(function(t){P&&O(T(t))},[O,P]),I=n(function(t){P&&O(C(t))},[O,P]),W=n(function(t){P||(t.preventDefault(),w(T(t)))},[P,w]),j=n(function(t){P||w(C(t))},[P,w]),R=n(function(){m&&S&&(m.save(),m.fillStyle="#ffffff",m.fillRect(0,0,S.width,S.height),m.restore(),S&&l&&l.pushState(S))},[m,S,l]),L=n(function(t){if(t){t.width=t.offsetWidth,t.height=t.offsetHeight;var r=t.getContext("2d");b(t),p(r),r&&(r.fillStyle="#ffffff",r.fillRect(0,0,t.width,t.height),r.fillStyle="transparent",l&&(l.setContext(r),l.pushState(t)))}},[l]),U=n(function(t){A(t.buttons)&&!P&&W(t)},[P,W]),B=n(function(t){},[]);return o(function(){if(P&&S){var t=function(t){if(P){var r=S.getBoundingClientRect(),n=[t.clientX-r.left,t.clientY-r.top];(n[0]<0||n[0]>S.width||n[1]<0||n[1]>S.height)&&n[0]>=-50&&n[0]<=S.width+50&&n[1]>=-50&&n[1]<=S.height+50&&O(n)}},r=function(){P&&x()};return document.addEventListener("mousemove",t),document.addEventListener("mouseup",r),function(){document.removeEventListener("mousemove",t),document.removeEventListener("mouseup",r)}}},[P,S,O,x]),i(e,function(){return{download:function(t,r){if(void 0===t&&(t="image.png"),S){var n=document.createElement("a");n.href=S.toDataURL(r),n.download=t,n.click()}},clear:R,getImageAsDataUri:function(t){return null==S?void 0:S.toDataURL(t)},context:m}},[S,m,R]),a("canvas",Object.assign({style:g({cursor:null==u?void 0:u.cursor,touchAction:"none"},c),onTouchStart:j,onMouseDown:W,onMouseEnter:U,onMouseMove:P?E:void 0,onTouchMove:P?I:void 0,onMouseUp:x,onMouseOut:B,onTouchEnd:x,ref:L},d),void 0)}),x=function(t,r){try{var n=new Image;return n.onload=function(){t.canvas.width=n.width,t.canvas.height=n.height,t.drawImage(n,0,0),URL.revokeObjectURL(n.src)},n.src=URL.createObjectURL(r),Promise.resolve()}catch(t){return Promise.reject(t)}};function E(e){var o=r([]),i=r(0),c=t(),a=c[0],l=c[1],s=t(!1),h=s[0],f=s[1],d=t(!1),v=d[0],g=d[1],m=n(function(t){try{var r=i.current;return a?(0!==r&&(o.current=o.current.slice(0,-r),i.current=0),Promise.resolve(new Promise(function(r){return t.toBlob(r)})).then(function(t){return t&&o.current.push(t),e&&o.current.length>e&&(o.current=o.current.slice(-e)),f(o.current.length>1),g(!1),!0})):(console.error("Context not initialised"),Promise.resolve(!1))}catch(t){return Promise.reject(t)}},[i,o,a]),p=n(function(){try{var t=i.current;return a?t+1>=o.current.length?(console.log("nope"),Promise.resolve(!1)):Promise.resolve(x(a,o.current[o.current.length-(t+2)])).then(function(){return i.current++,f(i.current+1<o.current.length),g(!0),!0}):(console.error("Context not initialised"),Promise.resolve(!1))}catch(t){return Promise.reject(t)}},[i,o,a]),k=n(function(){try{var t=i.current;return a?t<=0?Promise.resolve(!1):Promise.resolve(x(a,o.current[o.current.length-t])).then(function(){return i.current--,f(i.current+1<o.current.length),g(i.current>0),!0}):(console.error("Context not initialised"),Promise.resolve(!1))}catch(t){return Promise.reject(t)}},[o,i,a]),S=n(function(){o.current=[]},[o]);return{history:u(function(){return{setContext:function(t){l(t)},pushState:m}},[l,m]),undo:p,redo:k,clear:S,canUndo:h,canRedo:v}}export{O as Artboard,h as circleCursor,T as getMousePoint,C as getTouchPoint,A as mouseButtonIsDown,v as useAirbrush,f as useBrush,w as useEraser,E as useHistory,d as useMarker,p as useShadingBrush,M as useWatercolor};
//# sourceMappingURL=index.module.js.map
