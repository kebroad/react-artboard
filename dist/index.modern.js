import{useState as t,useRef as r,useCallback as e,forwardRef as n,useEffect as o,useImperativeHandle as a,useMemo as c}from"react";import i from"tinycolor2";import{jsx as u}from"react/jsx-runtime";function l(t,r){const e=Math.round(Math.random()*r),n=1-Math.random()/4;return i(t).darken(e-r/2).setAlpha(n).toPercentageRgbString()}const s=(t,r,e)=>[e[0]+t*Math.cos(r),e[1]+t*Math.sin(r)];function h(t){return`url(${function(t){return`data:image/svg+xml;base64,${btoa(function(t){return`<svg xmlns='http://www.w3.org/2000/svg' width='${t}' height='${t}' viewBox='0 0 ${t} ${t}'><circle r='${t/2}' cy='${t/2}' cx='${t/2}' stroke-width='1' stroke='rgba(0,0,0,0.5)' fill='none'/></svg>`}(t))}`}(t)}) ${t/2} ${t/2}, crosshair`}function d({color:n="#000000",strokeWidth:o=25,varyBrightness:a=5}){const[c,i]=t([]),u=r(),d=r();return{name:"Paintbrush",startStroke:e(t=>{u.current=void 0,i(function(t,r,e){const n=[],o=Math.round(t/3),a=t/o;for(let t=0;t<o;t++){const o=0===t?0:a*t+Math.random()*a/2-a/2;n.push({distance:o,thickness:2*Math.random()+2,colour:l(r,e)})}return n}(o,n,a)),d.current=t},[i,o,n,a]),continueStroke:e((t,r)=>{if(!d.current)return void(d.current=t);const e=((t,r,e)=>{const n=((t,r)=>(Math.atan2(r[1]-t[1],r[0]-t[0])-Math.PI/2)%(2*Math.PI))(t,r);return void 0===e?n:e-((t,r)=>{const e=2*Math.PI,n=(t-(r>0?r:r+e)+Math.PI)%e-Math.PI;return n<-Math.PI?n+e:n})(e,n)})(d.current,t,u.current);void 0===u.current&&(u.current=e%(2*Math.PI)),((t,r,e,n,o,a,c)=>{t.forEach(t=>{c.beginPath(),((t,r,e,n,o)=>{o.beginPath(),o.moveTo(t[0],t[1]),o.strokeStyle=e.colour,o.lineWidth=e.thickness,o.lineCap="round",o.lineJoin="round",o.shadowColor=e.colour,o.shadowBlur=e.thickness/2,o.quadraticCurveTo(n[0],n[1],r[0],r[1]),o.lineTo(r[0],r[1]),o.stroke()})(s(t.distance-a/2,n,r),s(t.distance-a/2,o,e),t,s(t.distance-a/2,o,r),c)})})(c,d.current,t,u.current,e,o,r),u.current=e%(2*Math.PI),d.current=t},[c,o]),cursor:h(o)}}function g({color:t="#000000",strokeWidth:n=25}){const o=r();return{name:"Marker",startStroke:e((r,e)=>{e.lineWidth=3,e.lineJoin=e.lineCap="round",o.current=r,e.strokeStyle=t},[t]),continueStroke:e((t,r)=>{if(o.current){if(o.current[0]!==t[0]||o.current[1]!==t[1]){r.beginPath();for(let e=0;e<n;e+=2){const a=Math.round(n/2-e);r.globalAlpha=1/n*(n-e),r.moveTo(o.current[0]-a,o.current[1]-a),r.lineTo(t[0]-a,t[1]-a),r.stroke()}r.globalAlpha=1,r.beginPath(),o.current=t}}else o.current=t},[n,o]),cursor:h(n)}}function m({color:t="#000000",strokeWidth:r=25}){const n=e((e,n)=>{n.globalCompositeOperation="darken",n.lineWidth=r,n.lineJoin=n.lineCap="round",n.strokeStyle=t,n.shadowBlur=.5*r,n.shadowColor=i(t).setAlpha(.5).toPercentageRgbString(),console.log(n.shadowColor),n.moveTo(e[0],e[1]),n.beginPath()},[t,r]),o=e(t=>{t.globalCompositeOperation="source-over"},[]);return{name:"Airbrush",startStroke:n,continueStroke:e((t,r)=>{r.lineTo(t[0],t[1]),r.stroke()},[]),endStroke:o,cursor:h(r)}}function p({color:t="#000000",neighbourColor:n,distanceThreshold:o=40,neighbourStrokeWidth:a=1,spreadFactor:c=.9}){n||(n=i(t).setAlpha(.2).toPercentageRgbString());const u=r([]),l=o*o;return{name:"Shading",startStroke:e((t,r)=>{r.globalCompositeOperation="darken",r.lineWidth=1,r.lineJoin=r.lineCap="round",u.current=[t]},[]),continueStroke:e((r,e)=>{e.strokeStyle=t,e.lineWidth=1,u.current.push(r),e.beginPath();const[o,i]=u.current[u.current.length-2];e.moveTo(o,i),e.lineTo(...r),e.stroke(),e.lineWidth=a;for(const t of u.current){const o=t[0]-r[0],a=t[1]-r[1],i=o*o+a*a;i<l&&Math.random()>i/l&&(e.beginPath(),e.strokeStyle=n,e.moveTo(r[0]+o*c,r[1]+a*c),e.lineTo(t[0]-o*c,t[1]-a*c),e.stroke())}},[a,t,c,l,n]),endStroke:e(t=>{t.globalCompositeOperation="source-over"},[]),cursor:"crosshair"}}let f=null;function k(){let t,r,e,n,o;if(null!==f)t=f,f=null;else{do{r=2*Math.random()-1,e=2*Math.random()-1,n=r*r+e*e}while(0===n||n>=1);o=Math.sqrt(-2*Math.log(n)/n),t=r*o,f=e*o}return t}function S(t,r,e,n,o){if(e<0)return[];const a=(t[1]+r[1])/2,c=[(t[0]+r[0])/2+k()*n,a+k()*n],i=S(t,c,e-1,n/o,o);return i.push(c),i.push(...S(c,r,e-1,n/o,o)),i}function b(t,r,e){r.beginPath(),function(t,r,e){return function(t,r,e,n){const o=[];for(let r=0;r<t.length;r++){const n=t[r],a=t[(r+1)%t.length];o.push(n),o.push(...S(n,a,5,e,2))}return o}(function(t,r,e){const n=2*Math.PI/r,o=[];for(let a=1;a<=r;a++)o.push([e*Math.cos(n*a)+t[0],e*Math.sin(n*a)+t[1]]);return o}(t,r,e),0,e/10)}(t,Math.round(e/5),e).forEach(t=>{r.lineTo(...t)}),r.closePath(),r.fill()}function M(t,r,e,n){const o=Math.min(e,t.length/3);for(let e=0;e<o;e++)n.globalAlpha=.01-.009/o*e,b(t[t.length-3*e-1],n,r+r/o*e);n.globalAlpha=.1}function v({color:t="#000000",strokeWidth:n=25}){const o=r([]),a=e((r,e)=>{e.fillStyle=t,e.shadowColor=t,e.globalAlpha=.01,o.current=[r],M(o.current,1.1*n,1,e)},[t,n]),c=e(()=>{o.current=[]},[]);return{name:"Watercolor",startStroke:a,continueStroke:e((t,r)=>{o.current.push(t),M(o.current,n,5,r)},[n]),endStroke:c,cursor:h(n)}}function C({strokeWidth:t=25}){return{name:"Eraser",startStroke:e((r,e)=>{e.globalCompositeOperation="source-over",e.lineWidth=t,e.strokeStyle="#ffffff",e.lineJoin=e.lineCap="round",e.moveTo(r[0],r[1]),e.beginPath()},[t]),continueStroke:e((t,r)=>{r.lineTo(t[0],t[1]),r.stroke()},[]),cursor:h(t)}}function y({color:t="#2c2c2c",strokeWidth:r=3,opacity:n=.8}){return{name:"Pencil",startStroke:e((e,o)=>{o.globalAlpha=n,o.lineWidth=r,o.strokeStyle=t,o.lineCap="round",o.lineJoin="round",o.globalCompositeOperation="multiply",o.moveTo(e[0],e[1]),o.beginPath()},[t,r,n]),continueStroke:e((t,e)=>{const n=.5*(Math.random()-.5);e.lineWidth=r+n,e.lineTo(t[0],t[1]),e.stroke()},[r]),endStroke:e(t=>{t.globalAlpha=1,t.globalCompositeOperation="source-over"},[]),cursor:h(r)}}function w({color:t="#1a1a1a",strokeWidth:n=15,roughness:o=.7}){const a=r();return{name:"Charcoal",startStroke:e((r,e)=>{e.globalAlpha=.6,e.strokeStyle=t,e.lineCap="round",e.lineJoin="round",e.globalCompositeOperation="multiply",a.current=r},[t]),continueStroke:e((t,r)=>{if(!a.current)return void(a.current=t);const e=Math.floor(n/3);for(let c=0;c<e;c++){r.beginPath();const e=(Math.random()-.5)*n*o,c=(Math.random()-.5)*n*o;r.lineWidth=3*Math.random()+1,r.moveTo(a.current[0]+e,a.current[1]+c),r.lineTo(t[0]+e,t[1]+c),r.stroke()}a.current=t},[n,o]),endStroke:e(t=>{t.globalAlpha=1,t.globalCompositeOperation="source-over"},[]),cursor:h(n)}}function P({color:t="#000000",strokeWidth:n=20,angle:o=45}){const a=r(),c=r();return{name:"Calligraphy",startStroke:e((r,e)=>{e.strokeStyle=t,e.lineCap="round",e.lineJoin="round",a.current=r,c.current=Date.now()},[t]),continueStroke:e((t,r)=>{if(!a.current||!c.current)return a.current=t,void(c.current=Date.now());const e=Date.now(),i=Math.max(e-c.current,1),u=t[0]-a.current[0],l=t[1]-a.current[1],s=Math.sqrt(u*u+l*l)/i,h=Math.atan2(l,u),d=Math.abs(h-o*Math.PI/180),g=Math.min(d,Math.PI-d),m=.8*Math.sin(g)+.2,p=Math.max(.3,1-.02*s),f=n*m*p;r.beginPath(),r.lineWidth=f,r.moveTo(a.current[0],a.current[1]),r.lineTo(t[0],t[1]),r.stroke(),a.current=t,c.current=e},[n,o]),cursor:h(n)}}function T({color:t="#000080",strokeWidth:n=4,flow:o=.9}){const a=r(),c=r(1);return{name:"Ink Pen",startStroke:e((r,e)=>{e.globalAlpha=o,e.strokeStyle=t,e.lineCap="round",e.lineJoin="round",e.shadowColor=t,e.shadowBlur=1,a.current=r,c.current=.5},[t,o]),continueStroke:e((t,r)=>{if(!a.current)return void(a.current=t);const e=t[0]-a.current[0],o=t[1]-a.current[1],i=Math.sqrt(e*e+o*o),u=Math.max(.3,Math.min(1,1-.01*i));c.current=.7*c.current+.3*u;const l=n*c.current;r.beginPath(),r.lineWidth=l;const s=(a.current[0]+t[0])/2,h=(a.current[1]+t[1])/2;r.moveTo(a.current[0],a.current[1]),r.quadraticCurveTo(a.current[0],a.current[1],s,h),r.stroke(),a.current=t},[n]),endStroke:e(t=>{t.globalAlpha=1,t.shadowBlur=0},[]),cursor:h(n)}}function W({color:t="#8B4513",strokeWidth:n=25,blending:o=.6}){const a=r();return{name:"Oil Paint",startStroke:e((r,e)=>{e.globalAlpha=.8,e.strokeStyle=t,e.lineCap="round",e.lineJoin="round",e.globalCompositeOperation="source-over",a.current=r},[t]),continueStroke:e((r,e)=>{if(a.current){for(let c=0;c<5;c++){e.beginPath();const u=i(t),l=20*(Math.random()-.5),s=u.lighten(l).toString();e.strokeStyle=s,e.lineWidth=n+4*(Math.random()-.5);const h=(Math.random()-.5)*n*.3,d=(Math.random()-.5)*n*.3;e.moveTo(a.current[0]+h,a.current[1]+d),e.lineTo(r[0]+h,r[1]+d),c>2?(e.globalCompositeOperation="multiply",e.globalAlpha=.5*o):(e.globalCompositeOperation="source-over",e.globalAlpha=.8),e.stroke()}a.current=r}else a.current=r},[t,n,o]),endStroke:e(t=>{t.globalAlpha=1,t.globalCompositeOperation="source-over"},[]),cursor:h(n)}}function A({color:t="#FF6B35",strokeWidth:n=20,opacity:o=.9}){const a=r();return{name:"Acrylic",startStroke:e((r,e)=>{e.globalAlpha=o,e.strokeStyle=t,e.lineCap="round",e.lineJoin="round",e.globalCompositeOperation="source-over",a.current=r},[t,o]),continueStroke:e((t,r)=>{if(!a.current)return void(a.current=t);r.beginPath(),r.lineWidth=n;const e=2*(Math.random()-.5);r.lineWidth=Math.max(1,n+e);const c=a.current[0]+.3*(t[0]-a.current[0]),i=a.current[1]+.3*(t[1]-a.current[1]),u=a.current[0]+.7*(t[0]-a.current[0]),l=a.current[1]+.7*(t[1]-a.current[1]);r.moveTo(a.current[0],a.current[1]),r.bezierCurveTo(c,i,u,l,t[0],t[1]),r.stroke(),Math.random()>.8&&(r.beginPath(),r.globalAlpha=.3*o,r.lineWidth=.6*n,r.moveTo(a.current[0],a.current[1]),r.lineTo(t[0],t[1]),r.stroke(),r.globalAlpha=o),a.current=t},[n,o]),endStroke:e(t=>{t.globalAlpha=1},[]),cursor:h(n)}}function O({color:t="#DC143C",strokeWidth:n=12,pressure:o=.6}){const a=r();return{name:"Crayon",startStroke:e((r,e)=>{e.globalAlpha=o,e.strokeStyle=t,e.lineCap="round",e.lineJoin="round",e.globalCompositeOperation="multiply",a.current=r},[t,o]),continueStroke:e((t,r)=>{if(a.current){for(let e=0;e<8;e++){r.beginPath();const c=.4*n,i=e/8*Math.PI*2,u=Math.cos(i)*c*Math.random(),l=Math.sin(i)*c*Math.random();r.lineWidth=Math.max(1,n*(.3+.7*Math.random())),r.globalAlpha=o*(.2+.6*Math.random()),r.moveTo(a.current[0]+u,a.current[1]+l),r.lineTo(t[0]+u,t[1]+l),r.stroke()}a.current=t}else a.current=t},[n,o]),endStroke:e(t=>{t.globalAlpha=1,t.globalCompositeOperation="source-over"},[]),cursor:h(n)}}function x({strokeWidth:t=30,strength:n=.8}){const o=r(),a=r(),c=r();return{name:"Smudge",startStroke:e((r,e)=>{o.current=r,a.current=e.canvas;const n=t,i=Math.max(0,r[0]-n),u=Math.max(0,r[1]-n),l=Math.min(a.current.width-i,2*n),s=Math.min(a.current.height-u,2*n);l>0&&s>0&&(c.current=e.getImageData(i,u,l,s))},[t]),continueStroke:e((r,e)=>{if(!o.current||!c.current||!a.current)return void(o.current=r);const i=r[0]-o.current[0],u=r[1]-o.current[1];if(Math.sqrt(i*i+u*u)<2)return;const l=document.createElement("canvas"),s=l.getContext("2d");if(!s)return;l.width=2*t,l.height=2*t,s.putImageData(c.current,0,0),e.globalAlpha=n,e.globalCompositeOperation="source-over";for(let n=0;n<5;n++){const o=(n+1)/5;e.drawImage(l,r[0]-t+i*o*.3,r[1]-t+u*o*.3,2*t,2*t)}const h=t,d=Math.max(0,r[0]-h),g=Math.max(0,r[1]-h),m=Math.min(a.current.width-d,2*h),p=Math.min(a.current.height-g,2*h);m>0&&p>0&&(c.current=e.getImageData(d,g,m,p)),o.current=r},[t,n]),endStroke:e(t=>{t.globalAlpha=1,t.globalCompositeOperation="source-over"},[]),cursor:h(t)}}function I(){return(I=Object.assign||function(t){for(var r=1;r<arguments.length;r++){var e=arguments[r];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])}return t}).apply(this,arguments)}const E=t=>{if(!t.currentTarget)return[0,0];const r=t.currentTarget.getBoundingClientRect(),e=t.targetTouches[0];return[e.clientX-r.left,e.clientY-r.top]},R=t=>[t.nativeEvent.offsetX,t.nativeEvent.offsetY],D=t=>1==(1&t),J=n(function(r,n){let{tool:c,style:i,history:l,onStartStroke:s,onContinueStroke:h,onEndStroke:d}=r,g=function(t,r){if(null==t)return{};var e,n,o={},a=Object.keys(t);for(n=0;n<a.length;n++)r.indexOf(e=a[n])>=0||(o[e]=t[e]);return o}(r,["tool","style","history","onStartStroke","onContinueStroke","onEndStroke"]);const[m,p]=t(),[f,k]=t(),[S,b]=t(!1),M=e(t=>{m&&(m.save(),b(!0),null==c.startStroke||c.startStroke(t,m),null==s||s(t))},[c,m,s]),v=e(t=>{m&&(null==c.continueStroke||c.continueStroke(t,m),null==h||h(t))},[c,m,h]),C=e(()=>{b(!1),m&&(null==c.endStroke||c.endStroke(m),null==d||d(),m.restore(),f&&l&&l.pushState(f))},[c,m,f,l,d]),y=e(t=>{S&&v(R(t))},[v,S]),w=e(t=>{S&&v(E(t))},[v,S]),P=e(t=>{S||(t.preventDefault(),M(R(t)))},[S,M]),T=e(t=>{S||M(E(t))},[S,M]),W=e(()=>{m&&f&&(m.save(),m.fillStyle="#ffffff",m.fillRect(0,0,f.width,f.height),m.restore(),f&&l&&l.pushState(f))},[m,f,l]),A=e(t=>{if(!t)return;t.width=t.offsetWidth,t.height=t.offsetHeight;const r=t.getContext("2d");k(t),p(r),r&&(r.fillStyle="#ffffff",r.fillRect(0,0,t.width,t.height),r.fillStyle="transparent",l&&(l.setContext(r),l.pushState(t)))},[l]),O=e(t=>{D(t.buttons)&&!S&&P(t)},[S,P]),x=e(t=>{},[]);return o(()=>{if(!S||!f)return;const t=t=>{if(!S)return;const r=f.getBoundingClientRect(),e=[t.clientX-r.left,t.clientY-r.top];(e[0]<0||e[0]>f.width||e[1]<0||e[1]>f.height)&&e[0]>=-50&&e[0]<=f.width+50&&e[1]>=-50&&e[1]<=f.height+50&&v(e)},r=()=>{S&&C()};return document.addEventListener("mousemove",t),document.addEventListener("mouseup",r),()=>{document.removeEventListener("mousemove",t),document.removeEventListener("mouseup",r)}},[S,f,v,C]),a(n,()=>({download:(t="image.png",r)=>{if(!f)return;const e=document.createElement("a");e.href=f.toDataURL(r),e.download=t,e.click()},clear:W,getImageAsDataUri:t=>null==f?void 0:f.toDataURL(t),context:m}),[f,m,W]),u("canvas",Object.assign({style:I({cursor:null==c?void 0:c.cursor,touchAction:"none"},i),onTouchStart:T,onMouseDown:P,onMouseEnter:O,onMouseMove:S?y:void 0,onTouchMove:S?w:void 0,onMouseUp:C,onMouseOut:x,onTouchEnd:C,ref:A},g),void 0)});async function B(t,r){const e=new Image;e.onload=()=>{t.canvas.width=e.width,t.canvas.height=e.height,t.drawImage(e,0,0),URL.revokeObjectURL(e.src)},e.src=URL.createObjectURL(r)}function $(n){const o=r([]),a=r(0),[i,u]=t(),[l,s]=t(!1),[h,d]=t(!1),g=e(async t=>{const r=a.current;if(!i)return console.error("Context not initialised"),!1;0!==r&&(o.current=o.current.slice(0,-r),a.current=0);const e=await new Promise(r=>t.toBlob(r));return e&&o.current.push(e),n&&o.current.length>n&&(o.current=o.current.slice(-n)),s(o.current.length>1),d(!1),!0},[a,o,i]),m=e(async()=>{const t=a.current;return i?t+1>=o.current.length?(console.log("nope"),!1):(await B(i,o.current[o.current.length-(t+2)]),a.current++,s(a.current+1<o.current.length),d(!0),!0):(console.error("Context not initialised"),!1)},[a,o,i]),p=e(async()=>{const t=a.current;return i?!(t<=0||(await B(i,o.current[o.current.length-t]),a.current--,s(a.current+1<o.current.length),d(a.current>0),0)):(console.error("Context not initialised"),!1)},[o,a,i]),f=e(()=>{o.current=[]},[o]);return{history:c(()=>({setContext:t=>{u(t)},pushState:g}),[u,g]),undo:m,redo:p,clear:f,canUndo:l,canRedo:h}}export{J as Artboard,h as circleCursor,R as getMousePoint,E as getTouchPoint,D as mouseButtonIsDown,A as useAcrylic,m as useAirbrush,d as useBrush,P as useCalligraphy,w as useCharcoal,O as useCrayon,C as useEraser,$ as useHistory,T as useInkPen,g as useMarker,W as useOilPaint,y as usePencil,p as useShadingBrush,x as useSmudge,v as useWatercolor};
//# sourceMappingURL=index.modern.js.map
