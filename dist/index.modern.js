import{useState as t,useRef as e,useCallback as n,forwardRef as r,useEffect as o,useImperativeHandle as c,useMemo as i}from"react";import u from"tinycolor2";import{jsx as a}from"react/jsx-runtime";function s(t,e){const n=Math.round(Math.random()*e),r=1-Math.random()/4;return u(t).darken(n-e/2).setAlpha(r).toPercentageRgbString()}const l=(t,e,n)=>[n[0]+t*Math.cos(e),n[1]+t*Math.sin(e)];function h(t){return`url(${function(t){return`data:image/svg+xml;base64,${btoa(function(t){return`<svg xmlns='http://www.w3.org/2000/svg' width='${t}' height='${t}' viewBox='0 0 ${t} ${t}'><circle r='${t/2}' cy='${t/2}' cx='${t/2}' stroke-width='1' stroke='rgba(0,0,0,0.5)' fill='none'/></svg>`}(t))}`}(t)}) ${t/2} ${t/2}, crosshair`}function d({color:r="#000000",strokeWidth:o=25,varyBrightness:c=5}){const[i,u]=t([]),a=e(),d=e();return{name:"Paintbrush",startStroke:n(t=>{a.current=void 0,u(function(t,e,n){const r=[],o=Math.round(t/3),c=t/o;for(let t=0;t<o;t++){const o=0===t?0:c*t+Math.random()*c/2-c/2;r.push({distance:o,thickness:2*Math.random()+2,colour:s(e,n)})}return r}(o,r,c)),d.current=t},[u,o,r,c]),continueStroke:n((t,e)=>{if(!d.current)return void(d.current=t);const n=((t,e,n)=>{const r=((t,e)=>(Math.atan2(e[1]-t[1],e[0]-t[0])-Math.PI/2)%(2*Math.PI))(t,e);return void 0===n?r:n-((t,e)=>{const n=2*Math.PI,r=(t-(e>0?e:e+n)+Math.PI)%n-Math.PI;return r<-Math.PI?r+n:r})(n,r)})(d.current,t,a.current);void 0===a.current&&(a.current=n%(2*Math.PI)),((t,e,n,r,o,c,i)=>{t.forEach(t=>{i.beginPath(),((t,e,n,r,o)=>{o.beginPath(),o.moveTo(t[0],t[1]),o.strokeStyle=n.colour,o.lineWidth=n.thickness,o.lineCap="round",o.lineJoin="round",o.shadowColor=n.colour,o.shadowBlur=n.thickness/2,o.quadraticCurveTo(r[0],r[1],e[0],e[1]),o.lineTo(e[0],e[1]),o.stroke()})(l(t.distance-c/2,r,e),l(t.distance-c/2,o,n),t,l(t.distance-c/2,o,e),i)})})(i,d.current,t,a.current,n,o,e),a.current=n%(2*Math.PI),d.current=t},[i,o]),cursor:h(o)}}function f({color:t="#000000",strokeWidth:r=25}){const o=e();return{name:"Marker",startStroke:n((e,n)=>{n.lineWidth=3,n.lineJoin=n.lineCap="round",o.current=e,n.strokeStyle=t},[t]),continueStroke:n((t,e)=>{if(o.current){if(o.current[0]!==t[0]||o.current[1]!==t[1]){e.beginPath();for(let n=0;n<r;n+=2){const c=Math.round(r/2-n);e.globalAlpha=1/r*(r-n),e.moveTo(o.current[0]-c,o.current[1]-c),e.lineTo(t[0]-c,t[1]-c),e.stroke()}e.globalAlpha=1,e.beginPath(),o.current=t}}else o.current=t},[r,o]),cursor:h(r)}}function g({color:t="#000000",strokeWidth:e=25}){const r=n((n,r)=>{r.globalCompositeOperation="darken",r.lineWidth=e,r.lineJoin=r.lineCap="round",r.strokeStyle=t,r.shadowBlur=.5*e,r.shadowColor=u(t).setAlpha(.5).toPercentageRgbString(),console.log(r.shadowColor),r.moveTo(n[0],n[1]),r.beginPath()},[t,e]),o=n(t=>{t.globalCompositeOperation="source-over"},[]);return{name:"Airbrush",startStroke:r,continueStroke:n((t,e)=>{e.lineTo(t[0],t[1]),e.stroke()},[]),endStroke:o,cursor:h(e)}}function k({color:t="#000000",neighbourColor:r,distanceThreshold:o=40,neighbourStrokeWidth:c=1,spreadFactor:i=.9}){r||(r=u(t).setAlpha(.2).toPercentageRgbString());const a=e([]),s=o*o;return{name:"Shading",startStroke:n((t,e)=>{e.globalCompositeOperation="darken",e.lineWidth=1,e.lineJoin=e.lineCap="round",a.current=[t]},[]),continueStroke:n((e,n)=>{n.strokeStyle=t,n.lineWidth=1,a.current.push(e),n.beginPath();const[o,u]=a.current[a.current.length-2];n.moveTo(o,u),n.lineTo(...e),n.stroke(),n.lineWidth=c;for(const t of a.current){const o=t[0]-e[0],c=t[1]-e[1],u=o*o+c*c;u<s&&Math.random()>u/s&&(n.beginPath(),n.strokeStyle=r,n.moveTo(e[0]+o*i,e[1]+c*i),n.lineTo(t[0]-o*i,t[1]-c*i),n.stroke())}},[c,t,i,s,r]),endStroke:n(t=>{t.globalCompositeOperation="source-over"},[]),cursor:"crosshair"}}let p=null;function m(){let t,e,n,r,o;if(null!==p)t=p,p=null;else{do{e=2*Math.random()-1,n=2*Math.random()-1,r=e*e+n*n}while(0===r||r>=1);o=Math.sqrt(-2*Math.log(r)/r),t=e*o,p=n*o}return t}function v(t,e,n,r,o){if(n<0)return[];const c=(t[1]+e[1])/2,i=[(t[0]+e[0])/2+m()*r,c+m()*r],u=v(t,i,n-1,r/o,o);return u.push(i),u.push(...v(i,e,n-1,r/o,o)),u}function S(t,e,n){e.beginPath(),function(t,e,n){return function(t,e,n,r){const o=[];for(let e=0;e<t.length;e++){const r=t[e],c=t[(e+1)%t.length];o.push(r),o.push(...v(r,c,5,n,2))}return o}(function(t,e,n){const r=2*Math.PI/e,o=[];for(let c=1;c<=e;c++)o.push([n*Math.cos(r*c)+t[0],n*Math.sin(r*c)+t[1]]);return o}(t,e,n),0,n/10)}(t,Math.round(n/5),n).forEach(t=>{e.lineTo(...t)}),e.closePath(),e.fill()}function b(t,e,n,r){const o=Math.min(n,t.length/3);for(let n=0;n<o;n++)r.globalAlpha=.01-.009/o*n,S(t[t.length-3*n-1],r,e+e/o*n);r.globalAlpha=.1}function M({color:t="#000000",strokeWidth:r=25}){const o=e([]),c=n((e,n)=>{n.fillStyle=t,n.shadowColor=t,n.globalAlpha=.01,o.current=[e],b(o.current,1.1*r,1,n)},[t,r]),i=n(()=>{o.current=[]},[]);return{name:"Watercolor",startStroke:c,continueStroke:n((t,e)=>{o.current.push(t),b(o.current,r,5,e)},[r]),endStroke:i,cursor:h(r)}}function w({strokeWidth:t=25}){return{name:"Eraser",startStroke:n((e,n)=>{n.globalCompositeOperation="source-over",n.lineWidth=t,n.strokeStyle="#ffffff",n.lineJoin=n.lineCap="round",n.moveTo(e[0],e[1]),n.beginPath()},[t]),continueStroke:n((t,e)=>{e.lineTo(t[0],t[1]),e.stroke()},[]),cursor:h(t)}}function y(){return(y=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(t[r]=n[r])}return t}).apply(this,arguments)}const C=t=>{if(!t.currentTarget)return[0,0];const e=t.currentTarget.getBoundingClientRect(),n=t.targetTouches[0];return[n.clientX-e.left,n.clientY-e.top]},P=t=>[t.nativeEvent.offsetX,t.nativeEvent.offsetY],T=t=>1==(1&t),W=r(function(e,r){let{tool:i,style:u,history:s,onStartStroke:l,onContinueStroke:h,onEndStroke:d}=e,f=function(t,e){if(null==t)return{};var n,r,o={},c=Object.keys(t);for(r=0;r<c.length;r++)e.indexOf(n=c[r])>=0||(o[n]=t[n]);return o}(e,["tool","style","history","onStartStroke","onContinueStroke","onEndStroke"]);const[g,k]=t(),[p,m]=t(),[v,S]=t(!1),b=n(t=>{g&&(g.save(),S(!0),null==i.startStroke||i.startStroke(t,g),null==l||l(t))},[i,g,l]),M=n(t=>{g&&(null==i.continueStroke||i.continueStroke(t,g),null==h||h(t))},[i,g,h]),w=n(()=>{S(!1),g&&(null==i.endStroke||i.endStroke(g),null==d||d(),g.restore(),p&&s&&s.pushState(p))},[i,g,p,s,d]),W=n(t=>{v&&M(P(t))},[M,v]),x=n(t=>{v&&M(C(t))},[M,v]),E=n(t=>{v||(t.preventDefault(),b(P(t)))},[v,b]),O=n(t=>{v||b(C(t))},[v,b]),R=n(()=>{g&&p&&(g.save(),g.fillStyle="#ffffff",g.fillRect(0,0,p.width,p.height),g.restore(),p&&s&&s.pushState(p))},[g,p,s]),I=n(t=>{if(!t)return;t.width=t.offsetWidth,t.height=t.offsetHeight;const e=t.getContext("2d");m(t),k(e),e&&(e.fillStyle="#ffffff",e.fillRect(0,0,t.width,t.height),e.fillStyle="transparent",s&&(s.setContext(e),s.pushState(t)))},[s]),A=n(t=>{T(t.buttons)&&!v&&E(t)},[v,E]),$=n(t=>{},[]);return o(()=>{if(!v||!p)return;const t=t=>{if(!v)return;const e=p.getBoundingClientRect(),n=[t.clientX-e.left,t.clientY-e.top];(n[0]<0||n[0]>p.width||n[1]<0||n[1]>p.height)&&n[0]>=-50&&n[0]<=p.width+50&&n[1]>=-50&&n[1]<=p.height+50&&M(n)},e=()=>{v&&w()};return document.addEventListener("mousemove",t),document.addEventListener("mouseup",e),()=>{document.removeEventListener("mousemove",t),document.removeEventListener("mouseup",e)}},[v,p,M,w]),c(r,()=>({download:(t="image.png",e)=>{if(!p)return;const n=document.createElement("a");n.href=p.toDataURL(e),n.download=t,n.click()},clear:R,getImageAsDataUri:t=>null==p?void 0:p.toDataURL(t),context:g}),[p,g,R]),a("canvas",Object.assign({style:y({cursor:null==i?void 0:i.cursor,touchAction:"none"},u),onTouchStart:O,onMouseDown:E,onMouseEnter:A,onMouseMove:v?W:void 0,onTouchMove:v?x:void 0,onMouseUp:w,onMouseOut:$,onTouchEnd:w,ref:I},f),void 0)});async function x(t,e){const n=new Image;n.onload=()=>{t.canvas.width=n.width,t.canvas.height=n.height,t.drawImage(n,0,0),URL.revokeObjectURL(n.src)},n.src=URL.createObjectURL(e)}function E(r){const o=e([]),c=e(0),[u,a]=t(),[s,l]=t(!1),[h,d]=t(!1),f=n(async t=>{const e=c.current;if(!u)return console.error("Context not initialised"),!1;0!==e&&(o.current=o.current.slice(0,-e),c.current=0);const n=await new Promise(e=>t.toBlob(e));return n&&o.current.push(n),r&&o.current.length>r&&(o.current=o.current.slice(-r)),l(o.current.length>1),d(!1),!0},[c,o,u]),g=n(async()=>{const t=c.current;return u?t+1>=o.current.length?(console.log("nope"),!1):(await x(u,o.current[o.current.length-(t+2)]),c.current++,l(c.current+1<o.current.length),d(!0),!0):(console.error("Context not initialised"),!1)},[c,o,u]),k=n(async()=>{const t=c.current;return u?!(t<=0||(await x(u,o.current[o.current.length-t]),c.current--,l(c.current+1<o.current.length),d(c.current>0),0)):(console.error("Context not initialised"),!1)},[o,c,u]),p=n(()=>{o.current=[]},[o]);return{history:i(()=>({setContext:t=>{a(t)},pushState:f}),[a,f]),undo:g,redo:k,clear:p,canUndo:s,canRedo:h}}export{W as Artboard,h as circleCursor,P as getMousePoint,C as getTouchPoint,T as mouseButtonIsDown,g as useAirbrush,d as useBrush,w as useEraser,E as useHistory,f as useMarker,k as useShadingBrush,M as useWatercolor};
//# sourceMappingURL=index.modern.js.map
